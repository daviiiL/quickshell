# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Quickshell** configuration - a QML-based Wayland compositor shell designed for use with the **Hyprland** window manager. Quickshell configurations use QML (Qt Meta Language) to define UI components and shell behavior.

The repository contains two shell implementations:

1. **Simple shell** (`/shell.qml`) - A minimal configuration with basic bar, screen corners, and OSD
2. **"ii" shell** (`/ii/shell.qml`) - A full-featured desktop environment with extensive customization options

## Running the Shell

```bash
# Run the default shell (if configured)
quickshell

# Run specific configuration by path
quickshell -p /home/david/.config/quickshell
quickshell -p /home/david/.config/quickshell/ii/shell.qml

# Run with no duplicate check (useful during development)
quickshell -n -p /home/david/.config/quickshell/ii/shell.qml

# Run in daemon mode
quickshell -d -p /home/david/.config/quickshell/ii/shell.qml

# Check version
quickshell --version
```

## Architecture

### Core Structure

- **`shell.qml`** - Simple shell entry point, loads basic modules (Bar, ScreenPaddings, ScreenCorners, Osd)
- **`ii/shell.qml`** - Full shell entry point with modular LazyLoader system
- **`colors.json`** - Material Design 3 color scheme (auto-generated by matugen, do not edit manually)

### ii Shell Components

The ii shell uses a modular architecture where components are lazy-loaded via the `LazyLoader` pattern. Each module can be enabled/disabled at the top of `ii/shell.qml`:

**Module Categories:**

- **`ii/modules/bar/`** - Top/side bar with workspaces, system tray, clock, battery, weather, etc.
- **`ii/modules/background/`** - Wallpaper handling and decorative background clock
- **`ii/modules/sidebarLeft/`** - App launcher and search interface
- **`ii/modules/sidebarRight/`** - Notifications, quick settings, calendar, AI assistant
- **`ii/modules/lock/`** - Screen lock interface
- **`ii/modules/dock/`** - Application dock (optional)
- **`ii/modules/overview/`** - Workspace overview
- **`ii/modules/onScreenDisplay/`** - Volume/brightness OSD popups
- **`ii/modules/onScreenKeyboard/`** - Virtual keyboard
- **`ii/modules/cheatsheet/`** - Keyboard shortcuts reference
- **`ii/modules/mediaControls/`** - Media player controls
- **`ii/modules/crosshair/`** - Gaming crosshair overlay
- **`ii/modules/regionSelector/`** - Screen region selection for screenshots
- **`ii/modules/wallpaperSelector/`** - Wallpaper picker interface

### Configuration System

**`ii/modules/common/Config.qml`** - Singleton that manages all user configuration

- Loads from `~/.config/quickshell/ii/options.json` (created automatically on first run)
- Uses `FileView` with `JsonAdapter` for reactive config watching
- Nested configuration access: `Config.options.bar.vertical`, `Config.options.appearance.transparency.enable`
- To modify config values: `Config.setNestedValue("bar.vertical", true)`

### Services (ii/services/)

Singletons that provide system integration:

- **`Ai.qml`** - AI assistant integration (OpenAI, Gemini, custom endpoints)
- **`Audio.qml`** - Audio/volume control via Pipewire
- **`Battery.qml`** - Battery status monitoring
- **`Brightness.qml`** - Screen brightness control (Hyprland integration)
- **`Network.qml`** - Network status and management
- **`Notifications.qml`** - Notification handling
- **`Wallpapers.qml`** - Wallpaper management and theming
- **`HyprlandData.qml`** - Workspaces and window information
- **`HyprlandKeybinds.qml`** - Keybind definitions
- **`MaterialThemeLoader.qml`** - Material Design theme application
- **`MprisController.qml`** - Media player control

### Common Utilities (ii/modules/common/)

- **`Appearance.qml`** - Theme and animation settings
- **`Directories.qml`** - Path definitions for assets and config
- **`Icons.qml`** - Icon loading helpers
- **`Images.qml`** - Image loading and caching
- **`functions/ColorUtils.qml`** - Color manipulation
- **`functions/StringUtils.qml`** - String processing
- **`functions/FileUtils.qml`** - File operations
- **`functions/fuzzysort.js`** - Fuzzy search algorithm (MIT license)

### Global State

**`ii/GlobalStates.qml`** - Singleton managing UI state

- Properties for open/closed states: `barOpen`, `sidebarLeftOpen`, `sidebarRightOpen`, etc.
- `screenZoom` property with Hyprland cursor zoom integration
- Workspace number display toggle via global shortcuts

### Simple Shell Components

- **`modules/`** - Top-level UI modules (Bar, Osd, ScreenCorners, ScreenPaddings, Background, Cheatsheet)
- **`components/`** - Reusable UI components (ClockWidget, PowerIndicator, StatusIcons, Tray, Modal, CircularProgress, MaterialSymbol, TrayItem, etc.)
- **`services/`** - System integration services (Audio, Bluetooth, Brightness, Network, Power)
- **`common/`** - Shared utilities and singletons (Colors, DateTime, Theme, GlobalStates, NiriKeybinds)

**`common/Theme.qml`** - Simple shell theme singleton defining fonts, spacing, rounding, animations

**`common/Colors.qml`** - Loads color scheme from `colors.json` (Material Design 3 colors)

## Color Theming

The `colors.json` file is **auto-generated by matugen** (wallpaper-based color generation). Do not edit manually.

Access colors in QML:

```qml
import "../common/"
Rectangle {
    color: Colors.current.primary
    border.color: Colors.current.outline
}
```

The ii shell uses Material Design 3 color system with full palette support (primary, secondary, tertiary, surface variants, etc.).

## QML Module System

Both shells use QML's module import system:

```qml
// Simple shell
import "../modules/"
import "../components/"
import "../common/"
import "../services/"

// ii shell
import qs.modules.common
import qs.modules.bar
import qs.services
```

## Development Workflow

1. **Edit QML files** - Changes are usually hot-reloaded by Quickshell
2. **Force reload** - If changes don't apply: restart `quickshell` process
3. **Config changes** - Modify `~/.config/quickshell/ii/options.json` or use in-shell settings
4. **Theme changes** - Run `matugen` to regenerate `colors.json` from wallpaper
5. **Test modules** - Toggle enable flags in `ii/shell.qml` to load only needed modules

## Hyprland Integration

This shell is tightly integrated with Hyprland via:

- `Quickshell.Hyprland` imports for workspace/window data
- `hyprctl` commands for system control (see `ii/GlobalStates.qml` for cursor zoom example)
- Hyprland IPC for keybinds and state synchronization
- Python script: `ii/scripts/hyprland/get_keybinds.py` extracts keybind configuration

## Key Patterns

**Singleton Pattern:**

```qml
pragma Singleton
Singleton { ... }
```

Used for Config, GlobalStates, services, Theme, Colors.

**LazyLoader Pattern:**

```qml
LazyLoader {
    active: enableBar && Config.ready
    component: Bar {}
}
```

Delays module instantiation until conditions are met.

**FileView Pattern:**

```qml
FileView {
    path: "..."
    watchChanges: true
    onFileChanged: reload()
}
```

Reactive file watching for config and assets.

## AI Assistant Integration

The ii shell includes an AI sidebar (`ii/services/Ai.qml`) with:

- Support for OpenAI API format and Gemini
- Custom model endpoints via `Config.options.ai.extraModels`
- System prompt with Linux/desktop context injection
- Function calling support for shell integration
- AI prompts in `ii/defaults/ai/prompts/` (personality templates)

## Important Notes

- **Module independence**: ii modules can be disabled without breaking the shell
- **Config watching**: User config changes apply in real-time (50ms debounce)
- **Material Design 3**: Full MD3 color system and animation curves
- **Wayland-only**: Designed for Wayland compositors (primarily Hyprland)
- **JavaScript utilities**: Some complex algorithms use `.js` files with `.pragma library`

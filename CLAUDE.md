# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a **Quickshell** configuration - a QML-based Wayland compositor shell designed for use with the **Hyprland** window manager. Quickshell configurations use QML (Qt Meta Language) to define UI components and shell behavior.

The repository contains two shell implementations:

1. **Simple shell** (`/shell.qml`) - A minimal configuration with basic bar, screen corners, and OSD
2. **"ii" shell** (`/ii/shell.qml`) - A full-featured desktop environment with extensive customization options

## Running the Shell

```bash
# Run the default shell (if configured)
quickshell

# Run specific configuration by path
quickshell -p /home/david/.config/quickshell
quickshell -p /home/david/.config/quickshell/ii/shell.qml

# Run with no duplicate check (useful during development)
quickshell -n -p /home/david/.config/quickshell/ii/shell.qml

# Run in daemon mode
quickshell -d -p /home/david/.config/quickshell/ii/shell.qml

# Check version
quickshell --version
```

## Architecture

### Core Structure

- **`shell.qml`** - Simple shell entry point, loads basic modules (Bar, ScreenPaddings, ScreenCorners, Osd)
- **`ii/shell.qml`** - Full shell entry point with modular LazyLoader system
- **`colors.json`** - Material Design 3 color scheme (auto-generated by matugen, do not edit manually)

### ii Shell Components

The ii shell uses a modular architecture where components are lazy-loaded via the `LazyLoader` pattern. Each module can be enabled/disabled at the top of `ii/shell.qml`:

**Module Categories:**

- **`ii/modules/bar/`** - Top/side bar with workspaces, system tray, clock, battery, weather, etc.
- **`ii/modules/background/`** - Wallpaper handling and decorative background clock
- **`ii/modules/sidebarLeft/`** - App launcher and search interface
- **`ii/modules/sidebarRight/`** - Notifications, quick settings, calendar, AI assistant
- **`ii/modules/lock/`** - Screen lock interface
- **`ii/modules/dock/`** - Application dock (optional)
- **`ii/modules/overview/`** - Workspace overview
- **`ii/modules/onScreenDisplay/`** - Volume/brightness OSD popups
- **`ii/modules/onScreenKeyboard/`** - Virtual keyboard
- **`ii/modules/cheatsheet/`** - Keyboard shortcuts reference
- **`ii/modules/mediaControls/`** - Media player controls
- **`ii/modules/crosshair/`** - Gaming crosshair overlay
- **`ii/modules/regionSelector/`** - Screen region selection for screenshots
- **`ii/modules/wallpaperSelector/`** - Wallpaper picker interface

### Configuration System

**`ii/modules/common/Config.qml`** - Singleton that manages all user configuration

- Loads from `~/.config/quickshell/ii/options.json` (created automatically on first run)
- Uses `FileView` with `JsonAdapter` for reactive config watching
- Nested configuration access: `Config.options.bar.vertical`, `Config.options.appearance.transparency.enable`
- To modify config values: `Config.setNestedValue("bar.vertical", true)`

### Services (ii/services/)

Singletons that provide system integration:

- **`Ai.qml`** - AI assistant integration (OpenAI, Gemini, custom endpoints)
- **`Audio.qml`** - Audio/volume control via Pipewire
- **`Battery.qml`** - Battery status monitoring
- **`Brightness.qml`** - Screen brightness control (Hyprland integration)
- **`Network.qml`** - Network status and management
- **`Notifications.qml`** - Notification handling
- **`Wallpapers.qml`** - Wallpaper management and theming
- **`HyprlandData.qml`** - Workspaces and window information
- **`HyprlandKeybinds.qml`** - Keybind definitions
- **`MaterialThemeLoader.qml`** - Material Design theme application
- **`MprisController.qml`** - Media player control

### Common Utilities (ii/modules/common/)

- **`Appearance.qml`** - Theme and animation settings
- **`Directories.qml`** - Path definitions for assets and config
- **`Icons.qml`** - Icon loading helpers
- **`Images.qml`** - Image loading and caching
- **`functions/ColorUtils.qml`** - Color manipulation
- **`functions/StringUtils.qml`** - String processing
- **`functions/FileUtils.qml`** - File operations
- **`functions/fuzzysort.js`** - Fuzzy search algorithm (MIT license)

### Global State

**`ii/GlobalStates.qml`** - Singleton managing UI state

- Properties for open/closed states: `barOpen`, `sidebarLeftOpen`, `sidebarRightOpen`, etc.
- `screenZoom` property with Hyprland cursor zoom integration
- Workspace number display toggle via global shortcuts

### Simple Shell Architecture

The simple shell (`shell.qml`) is a minimalist configuration organized into four main categories:

#### Modules (`modules/`)
Top-level UI components instantiated in `shell.qml`:
- **`Bar.qml`** - Left-side vertical bar with workspaces, system tray, notifications, status icons, clock, and power indicator
- **`StatusBar.qml`** - Bottom horizontal bar showing active window information via `WindowIndicator`
- **`Sidebar.qml`** - Right-side drawer with notifications and quick settings
- **`Osd.qml`** - On-screen display for volume and brightness feedback
- **`ScreenCorners.qml`** - Interactive screen corners (optional)
- **`ScreenPaddings.qml`** - Screen edge padding/margins (optional)
- **`Background.qml`** - Wallpaper management (optional)
- **`Cheatsheet.qml`** - Keyboard shortcuts reference overlay

**Module Pattern:** Each module uses `Scope` + `Variants` with `Quickshell.screens` to create instances per monitor:
```qml
Scope {
    Variants {
        model: Quickshell.screens
        PanelWindow {
            property var modelData
            screen: modelData
            // ...
        }
    }
}
```

#### Components (`components/`)
Reusable UI widgets organized by function:
- **Root components:** `ClockWidget`, `PowerIndicator`, `StatusIcons`, `Workspaces`, `SidebarComponent`
- **`components/notification/`** - Notification UI (NotificationButton, NotificationItem, NotificationGroup, NotificationListView)
- **`components/tray/`** - System tray (Tray, TrayItem, TrayMenu)
- **`components/widgets/`** - Generic widgets (MaterialSymbol, CircularProgress, ExpandingContainer, StyledText, ButtonGroup)
- **`components/statusbar/`** - Status bar widgets (WindowIndicator)

**Expanding Components Pattern:** Many components like `StatusIcons` and `PowerIndicator` use `ExpandingContainer` to animate between collapsed and expanded states, triggering parent bar width changes.

#### Services (`services/`)
Singleton services providing system integration via `pragma Singleton`:
- **`Audio.qml`** - Pipewire audio control (volume, mute state)
- **`Bluetooth.qml`** - Bluetooth device management
- **`Brightness.qml`** - Screen brightness via sysfs (`/sys/class/backlight/`)
- **`Network.qml`** - WiFi/network status
- **`Power.qml`** - Battery and power management
- **`Notifications.qml`** - Desktop notification handling

**Service Pattern:** Services expose readonly properties and use Quickshell's built-in integrations (`Quickshell.Services.Pipewire`, sysfs `FileView`, etc.) to react to system changes.

#### Common Utilities (`common/`)
Shared singletons and configuration:
- **`Theme.qml`** - Design system (fonts, spacing, rounding, animation curves/durations, bar dimensions)
- **`Colors.qml`** - Material Design 3 color scheme loader (from `colors.json`)
- **`GlobalStates.qml`** - UI state management (sidebar open/closed, OSD states, screen lock)
- **`DateTime.qml`** - Date/time utilities (if present)

**Theme Access:** Components import and use Theme properties:
```qml
import "../common/"
Rectangle {
    width: Theme.bar.width
    color: Colors.current.background
    radius: Theme.rounding.small
}
```

## Color Theming

The `colors.json` file is **auto-generated by matugen** (wallpaper-based color generation). Do not edit manually.

Access colors in QML:

```qml
import "../common/"
Rectangle {
    color: Colors.current.primary
    border.color: Colors.current.outline
}
```

The ii shell uses Material Design 3 color system with full palette support (primary, secondary, tertiary, surface variants, etc.).

## QML Module System

Both shells use QML's module import system:

```qml
// Simple shell
import "../modules/"
import "../components/"
import "../common/"
import "../services/"

// ii shell
import qs.modules.common
import qs.modules.bar
import qs.services
```

## Creating New Services (Simple Shell)

Services are singletons that provide system integration. To create a new service:

1. **Create service file** in `services/YourService.qml`:
```qml
pragma Singleton

import QtQuick
import Quickshell
import Quickshell.Io

Singleton {
    id: root

    // Expose readonly properties
    property real value: 0
    property bool initialized: false

    // Use Process for command output
    Process {
        id: reader
        command: ["your-command"]
        stdout: StdioCollector {
            onStreamFinished: {
                // Parse output
                root.value = parseFloat(this.text)
            }
        }
    }

    // Or use FileView for file-based data
    FileView {
        path: "/sys/class/your/device/value"
        watchChanges: true
        onFileChanged: this.reload()
        onLoaded: root.value = parseFloat(this.text())
    }

    Component.onCompleted: {
        // Initialize
        reader.running = true
    }
}
```

2. **Import in qmldir** (if using module paths) or import directly in components:
```qml
import "../services/"
// Now YourService is available globally
```

3. **Use in components:**
```qml
Text {
    text: YourService.value
}
```

**Key Patterns:**
- Use `pragma Singleton` at the top
- Wrap in `Singleton { }` component
- Expose `readonly property` for reactive data
- Use `Process` with `StdioCollector` for command output parsing
- Use `FileView` with `watchChanges: true` for file monitoring
- Initialize in `Component.onCompleted`

## Development Workflow

1. **Edit QML files** - Changes are usually hot-reloaded by Quickshell
2. **Force reload** - If changes don't apply: restart `quickshell` process or kill the process and restart
3. **Config changes** (ii shell) - Modify `~/.config/quickshell/ii/options.json` or use in-shell settings
4. **Theme changes** - Run `matugen` to regenerate `colors.json` from wallpaper
5. **Test modules** (ii shell) - Toggle enable flags in `ii/shell.qml` to load only needed modules
6. **Add to modules** (simple shell) - Edit `shell.qml` to instantiate new modules
7. **Debug services** - Use `console.log()` for debugging; output appears in terminal running quickshell

## Hyprland Integration

This shell is tightly integrated with Hyprland via:

- `Quickshell.Hyprland` imports for workspace/window data
- `hyprctl` commands for system control (see `ii/GlobalStates.qml` for cursor zoom example)
- Hyprland IPC for keybinds and state synchronization
- Python script: `ii/scripts/hyprland/get_keybinds.py` extracts keybind configuration

## Key Patterns

**Singleton Pattern:**

```qml
pragma Singleton
Singleton { ... }
```

Used for Config, GlobalStates, services, Theme, Colors.

**LazyLoader Pattern:**

```qml
LazyLoader {
    active: enableBar && Config.ready
    component: Bar {}
}
```

Delays module instantiation until conditions are met.

**FileView Pattern:**

```qml
FileView {
    path: "..."
    watchChanges: true
    onFileChanged: reload()
}
```

Reactive file watching for config and assets.

## AI Assistant Integration

The ii shell includes an AI sidebar (`ii/services/Ai.qml`) with:

- Support for OpenAI API format and Gemini
- Custom model endpoints via `Config.options.ai.extraModels`
- System prompt with Linux/desktop context injection
- Function calling support for shell integration
- AI prompts in `ii/defaults/ai/prompts/` (personality templates)

## Important Notes

- **Module independence**: ii modules can be disabled without breaking the shell
- **Config watching**: User config changes apply in real-time (50ms debounce)
- **Material Design 3**: Full MD3 color system and animation curves
- **Wayland-only**: Designed for Wayland compositors (primarily Hyprland)
- **JavaScript utilities**: Some complex algorithms use `.js` files with `.pragma library`
